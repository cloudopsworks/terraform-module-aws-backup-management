name: Terraform AWS Backup Management Module
#logo: logo/logo.jpg

license: "APACHE2"

copyrights:
  - name: "Cloud Ops Works LLC"
    url: "https://cloudops.works"
    year: "2024"

github_repo: terraform-module-aws-backup-management

description: |-
  Terraform module to create and manage AWS Backup resources at scale: backup vaults (including logically air-gapped
  vaults), backup plans and selections, advanced backup options per resource type, AWS Backup Region Settings, and
  optional cross-account sharing via AWS RAM. It helps standardize backup strategies, enforce encryption with KMS,
  and streamline operations across environments and accounts.

# Introduction to the project
introduction: |-
  This module provisions and manages AWS Backup across your AWS accounts and regions.
  It supports:
  • Backup vault creation with optional KMS encryption and logically air-gapped mode.
  • Backup plans, rules, lifecycles, and cross-region copy actions.
  • Backup selections by tags, ARNs, and conditional expressions.
  • Advanced backup options (e.g., Windows VSS) and region settings opt-ins.
  • Optional vault sharing via AWS RAM for multi-account strategies.

# How to use this project
usage: |-
  1. Ensure Terragrunt is installed and AWS credentials are configured.
  2. In your live repo, create a `terragrunt.hcl` pointing to this module and declare inputs.
  3. Copy the input structure below and tailor to your environment. Comments explain each field and defaults.

  ```hcl
  # terragrunt.hcl
  terraform {
    source = "git::git@github.com:cloudopsworks/terraform-module-aws-backup-management.git?ref=v1.0.0"
  }

  inputs = {
    # Core topology
    is_hub   = false                 # (Optional) Is this a hub (true) or spoke (false) deployment? Default: false
    spoke_def = "001"               # (Optional) Three-digit spoke identifier as string. Default: "001"
    org = {                          # (Required) Organization details used for naming and tagging
      organization_name = "acme"    # (Required) Your organization slug
      organization_unit = "plat"    # (Required) Business unit or team
      environment_type  = "prod"    # (Required) One of: prod|stage|dev|test|sandbox (free-form allowed)
      environment_name  = "primary" # (Required) Environment name or alias
    }
    extra_tags = {                   # (Optional) Additional resource tags. Default: {}
      Owner = "backup-team"
    }

    # Backup vault (standard or air-gapped)
    vault = {
      create                = true                 # (Optional) Create the vault with this module. Default: true
      name                  = ""                   # (Optional) Explicit name; required if name_prefix is empty
      name_prefix           = "acme-prod"         # (Optional) Used when name is empty; final: <prefix>-<system>-vault
      encryption_create_key = false                # (Optional) Create a new KMS key for this vault. Default: false
      encryption_key        = ""                   # (Optional) Existing KMS Key ARN when not creating a key
      encryption_alias      = "alias/backup-kms"  # (Optional) Existing KMS Alias when key ARN not provided
      force_destroy         = false                # (Optional) Allow delete even with recovery points. Default: false
    }

    air_gapped = {                  # (Optional) Logically Air-Gapped vault settings
      enabled            = false    # (Optional) Create LAG vault instead of standard. Default: false
      min_retention_days = 0        # (Optional) Minimum retention in days
      max_retention_days = 0        # (Optional) Maximum retention in days
    }

    # Region settings
    region_settings = {             # (Optional) Manage AWS Backup region settings
      enabled = false               # (Optional) Apply settings in this region. Default: false
      opt_ins = {                   # (Optional) Resource opt-ins: ENABLED|DISABLED
        LAMBDA = "ENABLED"
      }
      management_preference = {     # (Optional) SYSTEM|USER per resource type
        EBS = "SYSTEM"
      }
    }

    # Optional cross-account sharing of the vault via RAM
    ram = {
      enabled  = false              # (Optional) Enable AWS RAM share of the vault. Default: false
      accounts = [                  # (Optional) Account IDs to share with
        "111122223333"
      ]
    }

    # Backup plans (rules, selections, advanced options)
    backup_plans = {
      primary = {
        # Optional: custom role when vault.create=false, else module-managed role is used
        # role_arn = "arn:aws:iam::111122223333:role/BackupServiceRole"

        rules = {
          daily = {
            schedule           = "cron(0 12 * * ? *)"  # (Optional) CRON or rate expression
            timezone           = "UTC"                 # (Optional) IANA timezone
            continuous_backup  = true                  # (Optional) Default: false
            start_window       = 60                    # (Optional) Minutes
            completion_window  = 180                   # (Optional) Minutes
            recovery_point_tags = {                    # (Optional) Tags on recovery points
              Purpose = "daily"
            }
            lifecycle = {                              # (Optional)
              cold_storage_after = 30
              delete_after       = 365
              opt_in             = true               # Maps to opt_in_to_archive_for_supported_resources
            }
            copy_action = {                            # (Optional)
              destination_vault_arn = "arn:aws:backup:us-west-2:111122223333:backup-vault:dr"
              lifecycle = {
                cold_storage_after = 30
                delete_after       = 365
                opt_in             = true
              }
            }
          }
        }

        advanced = {                                  # (Optional) Advanced backup settings
          resource_type  = "EC2"                      # e.g., EC2, EBS, RDS, DDB, EFS, FSx, EKS
          backup_options = {
            WindowsVSS = "enabled"                    # Example for Windows/EC2
          }
        }

        resources = {                                  # (Optional) Selection definitions
          by_tag = {
            tags = [
              { type = "STRINGEQUALS", key = "backup", value = "true" }
            ]
          }
          explicit = {
            include_arns = [
              "arn:aws:ec2:us-east-1:111122223333:volume/vol-abc"
            ]
            exclude_arns = []
            conditions = [
              { string_equals = { key = "aws:ResourceTag/Env", value = "prod" } },
              { string_like   = { key = "aws:ResourceTag/App", value = "*api*" } }
            ]
          }
        }
      }
    }

    # Optional: define legal holds (if used by your governance framework)
    legal_holds = {
      # case123 = {
      #   description   = "Litigation hold for case 123"
      #   resource_arns = ["arn:aws:ec2:...:volume/vol-123"]
      #   tags          = { Case = "123" }
      # }
    }
  }
  ```

  4. Run `terragrunt init` to initialize the module.
  5. Execute `terragrunt plan` and `terragrunt apply` to deploy AWS Backup.

# Example usage
examples: |-
  ## Minimal Terragrunt Example

  ```hcl
  terraform {
    source = "git::git@github.com:cloudopsworks/terraform-module-aws-backup-management.git?ref=v1.0.0"
  }

  inputs = {
    org = { organization_name = "acme", organization_unit = "plat", environment_type = "dev", environment_name = "blue" }

    vault = { create = true, name_prefix = "acme-dev" }

    backup_plans = {
      default = {
        rules = {
          daily = {
            schedule          = "cron(0 2 * * ? *)"
            timezone          = "UTC"
            continuous_backup = true
          }
        }
      }
    }
  }
  ```

  - Creates a vault and a basic daily plan with point-in-time recovery.

  ## Advanced Terragrunt Example (Air-Gapped + Copy)

  ```hcl
  terraform {
    source = "git::git@github.com:cloudopsworks/terraform-module-aws-backup-management.git?ref=v1.0.0"
  }

  inputs = {
    is_hub = true
    org = { organization_name = "acme", organization_unit = "sec", environment_type = "prod", environment_name = "primary" }

    region_settings = {
      enabled = true
      opt_ins = { LAMBDA = "ENABLED", EBS = "ENABLED" }
    }

    vault = {
      create                = true
      name_prefix           = "acme-prod"
      encryption_create_key = true
    }

    air_gapped = { enabled = true, min_retention_days = 30, max_retention_days = 3650 }

    backup_plans = {
      critical = {
        rules = {
          monthly = {
            schedule          = "cron(0 0 1 * ? *)"
            timezone          = "UTC"
            lifecycle = { cold_storage_after = 30, delete_after = 365 }
            copy_action = {
              destination_vault_arn = "arn:aws:backup:us-west-2:111122223333:backup-vault:dr"
              lifecycle = { cold_storage_after = 60, delete_after = 730 }
            }
          }
        }
        advanced = {
          resource_type  = "EC2"
          backup_options = { WindowsVSS = "enabled" }
        }
        resources = {
          tag_sel = { tags = [{ type = "STRINGEQUALS", key = "backup", value = "true" }] }
        }
      }
    }
  }
  ```

  - Enables region settings, creates an air-gapped vault with KMS, and configures monthly backups with cross-region copy.

# How to get started quickly
quickstart: |-
  1. Install Terragrunt and configure AWS credentials (e.g., via AWS SSO or environment variables).
  2. Create `terragrunt.hcl` using the Usage section as a template.
  3. Run `terragrunt init` to download the module.
  4. Run `terragrunt plan` to review changes; then `terragrunt apply` to provision resources.
  5. Verify the created AWS Backup vault(s), plan(s), and selection(s) in the AWS Console.

include:
  - "docs/targets.md"
  - "docs/terraform.md"

contributors:
  - name: "Cristian Beraha"
    github: "berahac"